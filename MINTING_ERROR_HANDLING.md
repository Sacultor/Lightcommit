# 🎯 NFT 铸造错误处理说明

## 📋 关于控制台中的错误

### ❌ **错误代码 4001 - 用户拒绝交易**

这是 **正常的用户操作**，不是代码 bug。

#### 错误信息：
```
ethers-user-denied: MetaMask Tx Signature: User denied transaction signature.
code: ACTION_REJECTED (4001)
```

#### 发生原因：
- 用户在 MetaMask 弹窗中点击了 **"拒绝"** 或 **"取消"** 按钮
- 用户关闭了 MetaMask 签名窗口
- 用户主动取消了交易

---

## ✅ 已优化的错误处理

### 1️⃣ **用户拒绝交易 (4001)**
```
❌ 交易已取消
```
- 轻量级提示，不显示为错误
- 3 秒后自动消失
- 用户可以重新尝试

### 2️⃣ **余额不足**
```
❌ 余额不足，请确保有足够的 ETH 支付 Gas 费用
```
- 明确告知用户需要充值
- 提示检查钱包余额

### 3️⃣ **网络错误**
```
❌ 网络连接失败，请检查您的网络设置
```
- 提示用户检查网络连接
- 可能是 RPC 节点问题

### 4️⃣ **其他合约错误**
```
❌ [具体错误原因]
```
- 显示合约返回的具体错误信息
- 例如：Commit already minted、Max supply exceeded 等

---

## 🔍 常见铸造场景

### ✅ **成功铸造流程**
```
1. 点击 "Mint NFT" 按钮
2. MetaMask 弹出交易确认窗口
3. 检查 Gas 费用和交易详情
4. 点击 "确认"
5. 等待区块链确认（约 10-30 秒）
6. ✅ 显示成功页面，包含 Token ID 和交易哈希
```

### ❌ **用户拒绝流程**
```
1. 点击 "Mint NFT" 按钮
2. MetaMask 弹出交易确认窗口
3. 用户点击 "拒绝" 或关闭窗口
4. ❌ 显示 "交易已取消"
5. 铸造进度重置为 0%
6. 可以重新尝试
```

---

## 🛠️ 本地测试网铸造

### 前提条件：
1. **Hardhat 节点运行中**
   ```bash
   cd hardhat
   pnpm hardhat node
   ```

2. **合约已部署**
   ```bash
   pnpm hardhat run scripts/deploy-commit-nft.ts --network localhost
   ```

3. **MetaMask 连接到本地网络**
   - 网络名称: Localhost 8545
   - RPC URL: http://127.0.0.1:8545
   - Chain ID: 31337
   - 货币符号: ETH

4. **导入测试账户**
   - 从 Hardhat 控制台复制私钥
   - 在 MetaMask 中导入账户
   - 测试账户自动拥有 10000 ETH

---

## 💡 用户操作建议

### 铸造前检查清单：
- ✅ 钱包已连接（显示绿色 "已连接" 状态）
- ✅ 网络正确（Chain ID 与合约匹配）
- ✅ 账户有足够的 ETH（用于 Gas 费用）
- ✅ NFT 标题已填写

### 如果遇到问题：
1. **刷新页面** - 重新连接钱包
2. **检查 Hardhat 节点** - 确保后台运行
3. **查看控制台日志** - 获取详细错误信息
4. **切换账户** - 尝试使用不同的测试账户

---

## 📊 错误码参考

| 错误码 | 含义 | 用户操作 |
|--------|------|----------|
| 4001 | 用户拒绝交易 | 重新尝试，确认交易 |
| -32603 | 内部 JSON-RPC 错误 | 检查节点状态 |
| INSUFFICIENT_FUNDS | 余额不足 | 充值或使用测试账户 |
| NETWORK_ERROR | 网络连接问题 | 检查 RPC 节点 |
| CALL_EXCEPTION | 合约调用失败 | 检查合约状态和参数 |

---

## 🎉 成功铸造示例

### 成功页面显示：
```
✅ NFT Minted Successfully!

━━━━━━━━━━━━━━━━━━━
交易详情
━━━━━━━━━━━━━━━━━━━
Token ID: 1
接收地址: 0x247B...C055
交易哈希: 0x1234...5678 [查看]
━━━━━━━━━━━━━━━━━━━
```

### 控制台日志：
```
Minting commit... 
Transaction sent: 0x1234...
Transaction confirmed: { blockNumber: 2, ... }
✅ NFT 铸造成功！
```

---

## 🔄 重试机制

如果铸造失败（除了用户拒绝）：
1. 进度条重置为 0%
2. "Mint NFT" 按钮重新可用
3. 用户可以立即重试
4. 所有状态已清理

如果用户拒绝：
1. 不计入失败次数
2. 轻量级提示
3. 无需等待，立即可重试

---

## 🚀 最佳实践

### 开发环境：
- 使用 Hardhat 本地网络测试
- 频繁切换账户测试不同场景
- 模拟各种错误情况

### 生产环境：
- 使用测试网（Sepolia）进行最终测试
- 向用户明确展示 Gas 费用
- 提供交易追踪链接
- 保存交易历史记录

---

**✅ 当前版本已优化错误处理，用户体验更友好！**

