## 6 系统架构（System Architecture）

### 6.0 概述

本章从“系统分层 + 功能子系统”的角度，对 Lightcommit 的整体架构进行描述，重点围绕如何将 GitHub 提交（commit）映射为可验证的链上身份与声誉。系统整体遵循“链下计算、链上证明”的设计思路：  
- 链下负责接收 GitHub 事件、构建快照与元数据、运行评分与（未来的）AI/静态分析流水线；  
- 链上通过一组合约（ReputationRegistry、ValidationRegistry、CommitNFT、AgentIdentityRegistry）记录评分结果、触发凭证铸造，并维护开发者与 Agent 的身份与声誉。  

在实现层面，Lightcommit 由六个逻辑子系统构成：CommitNFT 合约、提交溯源流水线、多阶段 AI 评估流水线、反女巫信任引擎、开发者状态机以及 Agent 行为层（AgentOS）。其中部分能力已经在当前代码库中落地，部分为面向未来扩展的设计，本章会在小节中明确区分“已实现”与“规划中”。

---

### 6.1 CommitNFT Contract

#### 6.1.1 功能定位

CommitNFT 是一个面向 GitHub 提交的 ERC‑721 合约，用于将通过评估的 commit 铸造成不可篡改的链上凭证。每个 NFT 对应一次具体提交，并通过元数据（metadataURI）指向链下的评分结果与证据。

#### 6.1.2 已实现能力

- **基于提交的 NFT 数据模型**  
  合约定义 `CommitData` 结构体记录提交关键信息，包括：仓库名（`repo`）、commit 哈希字符串（`commit`）、增删行数（`linesAdded`、`linesDeleted`）、测试结果标记（`testsPass`）、时间戳（`timestamp`）、作者标识（`author`，字符串）、提交信息（`message`）以及是否合并（`merged`）。  
  这些数据通过 `mapping(uint256 ⇒ CommitData)` 与 tokenId 关联，一旦写入便不再修改，可以视为逻辑上“不可变的 commit 记录”。

- **去重与供给控制**  
  合约内部使用 `mapping(string ⇒ bool) _mintedCommits` 对 `commit` 字符串做唯一性约束，保证每个 commit 最多铸造一次 NFT。  
  同时定义全局最大供应量 `MAX_SUPPLY` 与每地址可铸造上限 `MAX_MINTS_PER_ADDRESS`，限制单地址过度铸造，从合约层面缓解女巫/滥用风险。

- **铸造方式与调用路径**  
  - 单次铸造：`mintCommit(to, commitData, metadataURI)` 为主路径，由合约 owner 调用。实际部署中通常将 CommitNFT 所有权转移至 `ValidationRegistry`，由后者在评分通过后自动触发铸造。  
  - 批量铸造：`batchMintCommits` 支持一次性铸造多条 Commit，限制批次数量以控制 gas。  
  - 签名铸造：合约实现了 EIP‑712 域与 `mintWithSignature`，由授权签名者离线签名，合约验证后完成铸造，作为后续更自动化 Agent 流程的扩展入口。

- **元数据与事件**  
  每次铸造都需要提供 `metadataURI`，通常为 IPFS 哈希，内部包含评分结果、各维度子分数与具体证据（diff 链接、测试结果、静态分析报告等）。  
  合约通过 `CommitMinted`、`BatchMinted` 等事件对 tokenId、接收者、仓库、commit 哈希以及部分统计信息进行日志记录，便于前端与索引器追踪铸造历史。

#### 6.1.3 规划中的能力

在设计层面，CommitNFT 还可以进一步扩展为更丰富的 commit 身份载体，例如：  
- 支持在链下元数据中存储压缩后的 diff 快照（当前仅以 URL 与报告形式存在）；  
- 将 Agent 身份（agent‑id）显式嵌入 CommitData，与 `AgentIdentityRegistry` 打通；  
- 与跨链桥或 Omnichain 协议集成，实现多链部署与统一的贡献凭证溯源。  
这些能力目前处于架构设计与 roadmap 阶段，尚未在现有合约中实现。

---

### 6.2 Commit Provenance Pipeline（提交溯源流水线）

#### 6.2.1 目标与总体结构

为了让每一枚 CommitNFT 都有清晰、可验证的来源，Lightcommit 将“提交溯源”设计为多层流水线，将 GitHub 事件、链下评估与链上状态组合成一个统一的 commit 身份对象。该流水线可抽象为三层：
- 链上证明层（On‑chain Proof Layer）  
- 链下快照与元数据层（Off‑chain Snapshot & Metadata Layer）  
- Agent 注释层（Agent Annotation Layer，规划中）

#### 6.2.2 链上证明层（已实现）

- **ReputationRegistry：评分与声誉注册表**  
  - 存储每个 `repo + commitSha` 的评分反馈（Feedback），字段包括：贡献者地址、仓库名、commit SHA、评分分值、反馈摘要哈希、元数据 URI、评审者地址、时间戳与存在标记。  
  - 接受带 EIP‑712 签名的 `SubmitParams`，验证签名者是否具备 `EVALUATOR_ROLE`，并通过 `nonce + timestamp` 限制重放（有效期默认 5 分钟）。  
  - 同时维护贡献者累计评分与反馈次数，为后续声誉分析与状态机提供底层数据。

- **ValidationRegistry：验证与触发铸造**  
  - 接受 `requestValidation(repo, commitSha, contributor, metadataURI)` 调用，内部计算 `commitHash`，从 ReputationRegistry 查询对应反馈。  
  - 若评分不存在或已被处理则拒绝；若评分大于等于阈值 `mintThreshold`（默认 80），则构造 `CommitData` 并调用 CommitNFT 的 `mintCommit` 完成铸造。  
  - 通过 `isMinted` 与 `commitToTokenId` 映射记录验证与铸造状态，并发出 `ValidationRequested`、`ValidationCompleted`、`MintTriggered` 等事件。

- **CommitNFT：提交凭证合约**  
  - 被 ValidationRegistry 作为下游依赖调用，用于存储最终的提交凭证 NFT。  
  - 与 ReputationRegistry 共同构成从“评分反馈”到“凭证铸造”的链上闭环。

这一层保证：只要有链上交易和事件，就能重建“该 commit 由谁在何时以何种分数通过验证并完成铸造”的完整证明路径。

#### 6.2.3 链下快照与元数据层（已实现）

- **GitHub Webhook 与数据入库**  
  - 通过 GitHub Webhook 接收 push/PR 事件，链下服务解析出 commit SHA、作者、仓库、时间、改动文件列表、增删改统计等信息。  
  - 使用数据库（Supabase/Postgres）持久化 `users`、`repositories`、`contributions` 等表，为前端展示与后续评估提供基础数据。

- **评分与元数据构建**  
  - 利用评分服务对每条贡献计算多维度分数，并通过聚合函数得到 0–100 的整体质量分。  
  - 调用 ERC‑8004 辅助工具生成包含总分、各维度分数与证据的 JSON 元数据（包括 diff 链接、测试结果、Linter 报告等），上传至 IPFS，获得 `ipfs://...` URI。  
  - 评分摘要哈希与元数据 URI 一起打包进 EIP‑712 Feedback 结构，由评审者钱包签名后提交给链上合约。

这一层承担了绝大部分计算与存储任务，链上只保留必要的摘要与指针，从而在保证可验证性的同时控制 gas 成本。

#### 6.2.4 Agent 注释层（规划中）

在设计层面，Lightcommit 还预留了“Agent 注释层”，用于记录 AI 对每次评分的推理过程与审查说明，包括：
- commit 的语义摘要（该提交试图解决什么问题、修改了哪部分功能）；  
- 主要决策依据（哪些信号导致高分/低分，哪些改动被视为风险点）；  
- 在多 Agent 模式下，不同 Agent 的意见分歧与最终共识路径。

当前代码库仍只持久化了最终的评分与基础证据，推理轨迹尚未上链或进入 IPFS 元数据，相关设计可作为论文中的扩展方向讨论。

---

### 6.3 Multi‑Stage AI Evaluation Pipeline（多阶段 AI 评估流水线）

#### 6.3.1 已实现的评分子系统

现阶段，Lightcommit 已落地的是一个“多维启发式打分 → 聚合为 0–100 分 → EIP‑712 上链”的轻量流水线，主要信号包括：

- **提交信息规范性**  
  - 检查 commit message 是否符合 Conventional Commits 规范（如 `feat: ...`、`fix: ...` 等），以及首行长度是否足够清晰。  
  - 规范性更好的提交在该维度获得更高分。

- **改动规模（size）**  
  - 根据增删行数总和进行分段打分：小而集中的改动得分最高，极大体量的改动被视为潜在风险，得分相对较低。  

- **文件影响（files impact）**  
  - 检查改动是否覆盖测试文件、是否几乎全部为文档、是否存在单文件大体量修改等。  
  - 涉及测试且改动结构合理的提交得分更高，仅文档或极重单文件修改会被适度降分。

- **合并信号（merge signal）**  
  - 针对 PR 场景，判断对应 PR 是否已被合并。合并状态被视为“已通过人工或流程审查”的弱信号。  

- **元数据完整度（metadata completeness）**  
  - 检查 message 中是否包含外部链接、是否引用 issue/PR 编号（如 `close #123`），以及整体描述是否完整。  

上述多个子分通过可调权重进行线性聚合，得到 0–100 的质量分数。随后，系统构造 EIP‑712 Feedback 结构体（包含 contributor、repo、commitSha、score、feedbackHash、timestamp、nonce 等），由具有 `EVALUATOR_ROLE` 的钱包进行签名，上链提交给 `ReputationRegistry`。

#### 6.3.2 规划中的完整五阶段流水线

在架构设计中，Lightcommit 将评估过程进一步拆解为五个可插拔阶段：

1. **Stage 1 – LLM 语义理解（规划中）**  
   引入大语言模型，对 commit 的语义、业务意图与上下文进行分析，判断其与项目目标、相关 issue/PR 的契合度，并输出结构化的语义标签与摘要。

2. **Stage 2 – 静态分析（规划中）**  
   集成 ESLint、Slither、Bandit 等多语言静态分析工具，对代码风格、一致性与潜在漏洞进行扫描，将告警数量与严重程度折算为评分信号。

3. **Stage 3 – 复杂度与可维护性指标（规划中）**  
   计算圈复杂度、Maintainability Index、重复代码比例等传统软件工程指标，用于刻画代码可维护性和长期演进成本。

4. **Stage 4 – 风险与安全评估（规划中）**  
   对安全敏感模块（如智能合约、鉴权逻辑）进行更严格的模式匹配、漏洞模式识别与风险打分。

5. **Stage 5 – 多 Agent 共识（规划中）**  
   引入 3–5 个独立 Agent，从风格、架构、安全、性能等不同维度分别打分，通过投票或加权平均形成共识分，并可给出置信区间或不确定性度量。

在论文中，可以将当前实现明确为“启发式多维度打分 + ERC‑8004 兼容反馈上链”，并将上述五阶段流水线视为可逐步接入的扩展框架，用于提升评估的鲁棒性与可解释性。

---

### 6.4 Anti‑Sybil Trust Engine（反女巫信任引擎）

#### 6.4.1 现有基础机制

为防止攻击者通过大量虚假账号与低价值 commit 刷分，Lightcommit 在 MVP 阶段首先实现了两类基础机制：

- **铸造限流**  
  CommitNFT 为每个地址设置最大可铸造数量 `MAX_MINTS_PER_ADDRESS`，同时有全局 `MAX_SUPPLY` 限制，防止个别地址集中占用大量凭证。

- **身份绑定**  
  `AgentIdentityRegistry` 将钱包地址与 GitHub 用户名绑定，避免同一 GitHub 账号以多地址反复注册 Agent 身份。在链下，GitHub OAuth 与 Webhook 验证也共同约束账号的真实性。

这些机制提供了最基本的反滥用、防女巫约束，为后续更复杂的信任建模打下基础。

#### 6.4.2 规划中的信任引擎

在完整设计中，Anti‑Sybil Trust Engine 将围绕“行为特征 + 模型推断”构建第二层信任过滤器：

- **输入特征（规划中）**  
  - commit 内容与元数据的向量嵌入（embeddings）；  
  - 开发者行为模式（提交频率、时间分布、项目/文件分布等）；  
  - 编码风格指纹（命名习惯、格式化风格、易错模式）；  
  - commit 图结构关系（与其他贡献者的协作边、review 关系与共同编辑的文件等）；  
  - 人类/Agent 分类器输出，用于区分人类开发者与自动化脚本/机器人。

- **输出结果（规划中）**  
  - Sybil Score（0–1 或 0–100 的女巫风险分数）；  
  - 异常行为标记（如高频微小改动、跨项目机械性重复的模式等）；  
  - 结合 Sybil Score 对声誉增量进行折扣或放大，从而动态调整开发者的有效信誉。

这套引擎目前处于设计与实验阶段，但在论文层面可以作为“在 Commit 质量之上进一步构建身份与行为信任”的关键组件进行讨论。

---

### 6.5 Developer State Machine（开发者状态机）

#### 6.5.1 概念状态机

为了在系统层面刻画开发者信任度的演化，Lightcommit 设计了一套开发者状态机，将链上声誉与 Anti‑Sybil 信号映射为有限状态：

- **New**：新接入用户，只完成基础绑定（如 GitHub ↔ 钱包），缺乏历史贡献记录。  
- **Verified**：已经完成钱包‑GitHub 绑定，并产生至少一次有效贡献。  
- **Trusted**：在较长时间内持续输出高质量贡献，累计声誉较高，且未被 Anti‑Sybil 引擎标记为异常。  
- **Flagged**：被检测出异常行为或高女巫风险，需要加强审查或人工复核。  
- **Suspended**：被判定为高风险或恶意账号，系统对其权限进行部分或完全冻结。

不同状态之间的迁移由多维信号驱动，包括：链上累计评分与平均分、Anti‑Sybil 的 Sybil Score、人工或 DAO 决策等。

#### 6.5.2 现有实现基础

当前合约已经提供了实现上述状态机所需的底层数据：

- `ReputationRegistry` 维护贡献者的总评分（`contributorTotalScore`）、反馈次数（`contributorFeedbackCount`）以及可由二者推导的平均分；  
- 事件 `ReputationUpdated` 记录了声誉随时间的变化轨迹，便于链下或治理模块重建状态演化过程。

在数据库或上层服务中，可以根据这些链上指标与 Anti‑Sybil 的输出定义一个具体的状态映射逻辑（例如以平均分和 Sybil Score 为阈值），并在用户画像中添加 `state` 字段。该映射逻辑属于应用与治理层的策略，目前仍在设计与迭代之中。

---

### 6.6 Agent Actions（AgentOS Layer）

#### 6.6.1 AgentOS 概念

AgentOS 层抽象的是一组可以自动执行“评估 → 签名 → 上链 → 铸造”流程的智能代理。其目标是从“人工触发 + 单一服务账户”演进为“多 Agent 协作 + 可治理的自动化系统”，使得每一次 commit 的评估与上链在无需人工干预的前提下持续进行。

#### 6.6.2 当前实现中的 Agent 行为映射

在现有系统中，部分 Agent 行为由链下服务与单一评审钱包承担：

- **evaluate commits：评估提交**  
  - Webhook 服务接收 GitHub 事件，并将其转化为标准化的贡献记录写入数据库；  
  - 评分服务根据 commit 元数据计算多维度分数，并聚合为整体质量分；  
  - 评审者钱包对 EIP‑712 Feedback 结构进行签名。

- **mint CommitNFT：铸造贡献凭证**  
  - 前端或后台服务调用 `ReputationRegistry.submitFeedback` 与 `ValidationRegistry.requestValidation`，由 ValidationRegistry 在评分达标时自动触发 CommitNFT 铸造。

- **write review reports：撰写评审报告**  
  - 评分结果与证据被打包为 JSON，上传至 IPFS，由 `metadataURI` 与链上 Feedback 与 NFT 关联，形成可审计的“评审报告”。

- **detect risks / run static analysis：风险检测与静态分析（部分）**  
  - 工程本身配置了 Linter 与测试工具，但尚未统一纳入同一 AI 评估流水线与链上反馈结构，相关集成属于下一阶段工作。

从架构视角看，这一套链下服务 + 钱包组合已经构成了一个“单 Agent” 的雏形：它具备从 GitHub 拉取数据、运行评分逻辑、签名并与合约交互的完整闭环。

#### 6.6.3 向多 AgentOS 的演进方向

在未来版本中，AgentOS 层可以沿以下方向扩展：

- 将“评分 → 风险分析 → 签名 → 上链”的流程拆解为多个独立角色（语义分析 Agent、静态分析 Agent、安全审计 Agent、合约交互 Agent 等），由一个调度器或工作流引擎编排多 Agent 的执行顺序与数据流；  
- 利用 `AgentIdentityRegistry` 管理 Agent 身份，并结合链上 AccessControl、时间锁、多签等机制，对关键 Agent 的权限（如铸造阈值调整、评审者名单更新等）进行细粒度治理；  
- 为每个 Agent 输出的决策附加可验证的 reasoning trace 与置信度信息，并与 Anti‑Sybil 与开发者状态机协同工作，形成一个可解释、可治理、可审计的 Agent 信任网络。

通过上述演进，Lightcommit 可以逐步从“人驱动的评审系统”过渡到“由多 Agent 驱动的自动化信誉层”，同时保留足够的治理与安全控制。



