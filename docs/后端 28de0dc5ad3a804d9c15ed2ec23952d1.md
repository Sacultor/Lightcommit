# 后端

作者: Asmat Naoka
状态: 草稿
类别: PRD
上次编辑时间: 2025年10月15日 15:18

### **1. 核心架构与模块化设计**

**项目结构预览:**

`backend/
├── src/
│   ├── app.module.ts             # 根模块
│   ├── main.ts                   # 应用入口
│   │
│   ├── auth/                     # 认证模块 (GitHub OAuth)
│   │   ├── auth.module.ts
│   │   ├── auth.controller.ts
│   │   └── strategies/github.strategy.ts
│   │
│   ├── github/                   # GitHub 交互模块
│   │   ├── github.module.ts
│   │   ├── github.controller.ts  # 接收 Webhooks
│   │   └── github.service.ts     # 调用 GitHub API
│   │
│   ├── blockchain/               # 区块链交互模块
│   │   ├── blockchain.module.ts
│   │   └── blockchain.service.ts # 钱包、Gas管理、调用合约
│   │
│   ├── contribution/             # 贡献业务逻辑模块
│   │   ├── contribution.module.ts
│   │   ├── contribution.service.ts
│   │   ├── contribution.controller.ts
│   │   └── entities/contribution.entity.ts # 数据库实体
│   │
│   ├── queue/                    # 任务队列模块 (处理铸造任务)
│   │   ├── queue.module.ts
│   │   └── queue.processor.ts
│   │
│   └── database/                 # 数据库模块
│       └── database.module.ts
│
└── test/`

---

### **2. 基础模块配置**

- **配置管理 (`ConfigModule`)**:
    - 使用官方的 `@nestjs/config` 模块来管理环境变量。
    - 创建类型安全的配置服务，从 `.env` 文件加载 `GITHUB_CLIENT_ID`、`GITHUB_CLIENT_SECRET`、`DATABASE_URL`、`SEPOLIA_PRIVATE_KEY` 等敏感信息。
- **数据库 (`DatabaseModule`)**:
    - **技术栈**: **PostgreSQL + TypeORM** (或 Prisma)，TypeORM 与 NestJS 深度集成 (`@nestjs/typeorm`)。
    - **功能**:
        - 配置数据库连接。
        - 定义数据实体 (Entities)，例如 `User`, `Contribution`, `Repository`。
        - `Contribution` 实体应包含字段：`githubId`、`type` (commit/pr)、`repoName`、`contributor`、`status` (pending/minted)、`transactionHash`、`tokenId`。

---

### **3. 核心功能模块**

- **认证模块 (`AuthModule`)**:
    - **技术栈**: `@nestjs/passport`, `passport-github2`。
    - **功能**:
        - 实现一个 `GithubStrategy`，处理 GitHub OAuth2.0 的回调逻辑。
        - 创建 `/api/auth/github` 路由用于发起授权，`/api/auth/github/callback` 用于处理回调。
        - 成功授权后，创建或查找用户，并使用 JWT (`@nestjs/jwt`) 生成访问令牌返回给前端。
- **GitHub 模块 (`GithubModule`)**:
    - **技术栈**: `@nestjs/axios` (用于 API 请求), `crypto` (用于验证 webhook 签名)。
    - `GithubController`: 创建一个 `/api/github/webhook` 端点，专门用于接收和验证来自 GitHub 的 Webhook 事件。
    - `GithubService`:
        - 封装对 GitHub API 的调用逻辑 (例如，通过 commit hash 获取详细信息)。
        - 处理 Webhook payload，解析出有效贡献，然后**将待处理的贡献任务添加到任务队列**中，实现异步解耦。
- **任务队列模块 (`QueueModule`)**:
    - **技术栈**: **Redis + `@nestjs/bull`**。
    - **功能**:
        - 创建一个名为 `minting` 的任务队列。
        - `GithubService` 在验证贡献后，将任务 `add('mint-contribution', { contributionId: ... })` 到队列。
        - 创建一个 `QueueProcessor` (处理器)，监听 `minting` 队列。当接收到任务时，调用 `BlockchainService` 执行具体的铸造操作。
- **区块链模块 (`BlockchainModule`)**:
    - **技术栈**: **Ethers.js** 或 **Viem** (项目 `hardhat/package.json` 中已包含)。
    - `BlockchainService`:
        - **钱包管理**: 使用 `@nestjs/config` 安全地加载私钥，并初始化一个 `Wallet` 实例用于签名交易。
        - **合约交互**: 加载 `hardhat` 工作区编译好的智能合约 ABI，创建合约实例。
        - **核心方法 `mintContribution(contributionId)`**:
            1. 从数据库中查找贡献详情。
            2. 将贡献元数据上传到 IPFS，获取 `metadataURI`。
            3. 调用智能合约的 `mint` 方法，传入接收地址、Token ID 和 `metadataURI`。
            4. 等待交易上链，获取 `transactionHash`。
            5. 更新数据库中对应贡献记录的状态为 `minted`，并保存交易哈希和 Token ID。
- **贡献模块 (`ContributionModule`)**:
    - `ContributionController`: 提供面向前端的 API，例如 `GET /api/contributions` 来查询用户的贡献和铸造历史。
    - `ContributionService`: 封装对 `Contribution` 实体的数据库操作。

---

### **4. API 设计与数据验证**

- **DTO (Data Transfer Objects)**: 为所有 Controller 的输入和输出创建 DTO 类。
- **验证**: 使用 `class-validator` 和 `class-transformer` 配合 NestJS 内置的 `ValidationPipe`，对所有传入的 API 请求体进行自动验证。

### **5. 智能合约集成**

- 后端通过读取 `hardhat/artifacts/contracts/YourContract.sol/YourContract.json` 文件来获取 ABI，从而与已部署的合约进行交互。