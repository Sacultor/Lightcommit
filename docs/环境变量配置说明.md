# 环境变量配置说明

## 📋 重要变更

**前端环境变量文件已从 `.env.local` 改为 `.env`**

---

## ✅ 更新内容

### 文件位置

```
frontend/
  ├── env.example      # 环境变量模板（复制此文件）
  └── .env            # 实际配置文件（需要创建）✅ 新位置
      # 旧位置: .env.local ❌ 已废弃
```

### 配置步骤

```bash
# 1. 进入前端目录
cd frontend

# 2. 复制模板文件
cp env.example .env

# 3. 编辑 .env 文件
vim .env  # 或使用其他编辑器
```

---

## 📝 必需的环境变量

### 数据库配置

```bash
# PostgreSQL 数据库连接
DATABASE_URL=postgresql://user:password@localhost:5432/lightcommit

# Supabase 配置（如果使用 Supabase）
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here
```

### GitHub OAuth 配置

```bash
# GitHub OAuth 应用凭证
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# GitHub Webhook 密钥
GITHUB_WEBHOOK_SECRET=your_webhook_secret_here
```

### JWT 配置

```bash
# JWT 签名密钥（用于用户认证）
JWT_SECRET=your_jwt_secret_here_min_32_characters
```

### 区块链配置

```bash
# 合约地址
NEXT_PUBLIC_COMMIT_NFT_ADDRESS=0x...
NEXT_PUBLIC_AGENT_REGISTRY_ADDRESS=0x...
NEXT_PUBLIC_REPUTATION_REGISTRY_ADDRESS=0x...
NEXT_PUBLIC_VALIDATION_REGISTRY_ADDRESS=0x...

# RPC 节点
NEXT_PUBLIC_RPC_URL=https://sepolia.infura.io/v3/your_key

# 区块浏览器
NEXT_PUBLIC_EXPLORER_URL=https://sepolia.etherscan.io

# 链 ID
NEXT_PUBLIC_CHAIN_ID=11155111
```

### IPFS 配置（可选）

**重要**：IPFS 配置是可选的，不配置也能运行！

```bash
# 方案 1：Web3.Storage（推荐，完全免费）
WEB3_STORAGE_TOKEN=your_web3_storage_token

# 方案 2：Pinata（有免费套餐）
PINATA_API_KEY=your_pinata_api_key
PINATA_SECRET_API_KEY=your_pinata_secret_key

# 方案 3：不配置（开发测试）
# 系统会自动使用 mock 哈希
```

**详细说明**：参考 [IPFS 配置指南](./IPFS配置指南.md)

---

## 🔍 已更新的文件

### 文档文件（14个）

- ✅ `docs/Webhook测试快速开始.md`
- ✅ `docs/Webhook测试指南.md`
- ✅ `docs/Webhook测试资源总结.md`
- ✅ `docs/替换Mock数据指南.md`
- ✅ `docs/Mock数据替换总结.md`
- ✅ `docs/lib目录详解.md`
- ✅ `docs/frontend.md`
- ✅ `docs/GITHUB_OAUTH_SETUP.md`
- ✅ `docs/BROWSER_USAGE_GUIDE.md`
- ✅ `docs/ERC8004_IMPLEMENTATION.md`
- ✅ `docs/ERC8004_README.md`
- ✅ `README.md`
- ✅ `frontend/scripts/README.md`
- ✅ `hardhat/RE_DEPLOYMENT_GUIDE.md`
- ✅ `hardhat/QUICK_DEPLOY.md`

### 源代码文件（4个）

- ✅ `frontend/src/app/api/auth/github/route.ts`
- ✅ `frontend/src/app/api/ipfs/upload/route.ts`
- ✅ `hardhat/scripts/redeploy.ts`
- ✅ `hardhat/scripts/deploy-commit-nft.ts`

---

## ⚠️ 注意事项

### 1. `.env` vs `.env.local`

- **使用 `.env`**：前端环境变量配置
- **`.env.local` 已废弃**：请不要再创建或使用此文件

### 2. Git 忽略配置

`.env` 文件已在 `.gitignore` 中配置，不会被提交到版本控制：

```gitignore
# 环境变量文件
.env
.env.local
.env.*.local
```

### 3. Next.js 环境变量规则

#### 浏览器端可访问的变量

- 必须以 `NEXT_PUBLIC_` 开头
- 会被打包到客户端代码中
- 示例：`NEXT_PUBLIC_API_URL`

#### 服务端专用变量

- 不需要特殊前缀
- 只能在服务端代码中访问
- 示例：`DATABASE_URL`, `JWT_SECRET`

### 4. 安全建议

- ✅ **不要提交 `.env` 文件到 Git**
- ✅ **使用强密码和随机密钥**
- ✅ **生产环境使用不同的配置**
- ✅ **定期轮换敏感密钥**
- ❌ **不要在前端暴露敏感信息**

---

## 🚀 快速配置模板

### 开发环境（本地测试）

```bash
# frontend/.env

# 数据库
DATABASE_URL=postgresql://postgres:password@localhost:5432/lightcommit

# GitHub OAuth
GITHUB_CLIENT_ID=your_dev_client_id
GITHUB_CLIENT_SECRET=your_dev_client_secret
GITHUB_WEBHOOK_SECRET=test_secret_123

# JWT
JWT_SECRET=dev_jwt_secret_min_32_characters_long

# 区块链（Sepolia 测试网）
NEXT_PUBLIC_COMMIT_NFT_ADDRESS=0x...
NEXT_PUBLIC_RPC_URL=https://sepolia.infura.io/v3/your_key
NEXT_PUBLIC_CHAIN_ID=11155111
NEXT_PUBLIC_EXPLORER_URL=https://sepolia.etherscan.io

# API
NEXT_PUBLIC_API_URL=http://localhost:3000/api
```

### 生产环境

```bash
# frontend/.env

# 数据库（使用生产数据库）
DATABASE_URL=postgresql://user:secure_password@production-host:5432/lightcommit

# GitHub OAuth（使用生产应用）
GITHUB_CLIENT_ID=production_client_id
GITHUB_CLIENT_SECRET=production_client_secret
GITHUB_WEBHOOK_SECRET=production_webhook_secret

# JWT（使用强密钥）
JWT_SECRET=production_jwt_secret_very_long_and_random

# 区块链（主网）
NEXT_PUBLIC_COMMIT_NFT_ADDRESS=0x...
NEXT_PUBLIC_RPC_URL=https://mainnet.infura.io/v3/your_key
NEXT_PUBLIC_CHAIN_ID=1
NEXT_PUBLIC_EXPLORER_URL=https://etherscan.io

# API
NEXT_PUBLIC_API_URL=https://your-domain.com/api
```

---

## 🔧 环境变量验证

### 检查配置是否正确

```bash
# 1. 启动开发服务器
cd frontend
npm run dev

# 2. 访问健康检查接口
curl http://localhost:3000/api/health

# 3. 预期输出
{
  "status": "ok",
  "database": "connected",
  "timestamp": "2024-11-20T..."
}
```

### 常见错误排查

#### 错误：找不到环境变量

```
Error: Missing required environment variable: DATABASE_URL
```

**解决**：
1. 检查 `.env` 文件是否存在
2. 确认变量名拼写正确
3. 重启开发服务器

#### 错误：数据库连接失败

```
Error: connect ECONNREFUSED 127.0.0.1:5432
```

**解决**：
1. 确认数据库服务已启动
2. 检查 `DATABASE_URL` 配置
3. 验证用户名和密码

#### 错误：GitHub OAuth 失败

```
Error: GitHub OAuth not configured
```

**解决**：
1. 检查 `GITHUB_CLIENT_ID` 和 `GITHUB_CLIENT_SECRET`
2. 确认 GitHub OAuth 应用配置正确
3. 重启开发服务器

---

## 📚 相关文档

- [Webhook 测试指南](./Webhook测试指南.md) - 如何测试 webhook 功能
- [替换 Mock 数据指南](./替换Mock数据指南.md) - 如何使用真实数据
- [GitHub OAuth 设置](./GITHUB_OAUTH_SETUP.md) - OAuth 配置详解

---

## 🆘 获取帮助

如果遇到环境变量配置问题：

1. 查看 `frontend/env.example` 了解所有可用的配置项
2. 阅读相关文档中的配置说明
3. 检查开发服务器的日志输出
4. 确认所有服务（数据库、RPC 节点等）正常运行

---

## 📝 更新日志

- **2024-11-20**：将前端环境变量文件从 `.env.local` 改为 `.env`
  - 更新所有文档引用
  - 更新源代码注释
  - 统一配置说明

